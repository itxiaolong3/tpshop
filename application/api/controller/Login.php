<?php/** * Created by PhpStorm. * User: Administrator * Date: 2019/3/20 * Time: 10:57 */namespace app\api\controller;use app\api\controller\Weixin;use app\api\model\Users;use app\api\service\Token;use think\Controller;class Login extends Controller {    public function _initialize()    {        parent::_initialize(); // TODO: Change the autogenerated stub    }    public function index($code = ''){        $weixin = new Weixin();        $openid = $weixin->GetOpenid($code);        if($openid){            $userinfo = M('users')->where((['openid'=>$openid]))->find();            $token = $userinfo['token'];            $token_expres = Token::checkTokenExpress($token);            if($userinfo){                if($token_expres === true){                    $token_express = $userinfo['token_express'];                }else{                    $express = Token::updateTokenExpress($token);                    $token = $express['token'];                    $token_express = $express['express'];                }               // returnApiSuccess(['msg'=>'请求数据成功','token'=>$token,'user_id'=>$userinfo['user_id'],'form_url'=>'http://hua.chinatysw.cn/login?code=']);               $uri="http://hua.chinatysw.cn/login?code=".$token;                Header("location:".$uri."");                die;             // header("location:http://hua.chinatysw.cn/login?code=".$token);               // returnOk(['msg'=>'请求数据成功','token'=>$token,'user_id'=>$userinfo['user_id'],'form_url'=>'http://hua.chinatysw.cn/login?code=']);            }else{                $user_id = Users::addUser($openid);                $info = Users::get($user_id);                $uri="http://hua.chinatysw.cn/login?code=".$token;                Header("location:".$uri."");                die;                //returnApiSuccess(['msg'=>'请求数据成功','token'=>$token,'user_id'=> $user_id,'form_url'=>'http://hua.chinatysw.cn/login?code=']);            }        }else{            returnBad(['请求openid失败']);        }    }    //获取小程序openid    public function getopenid(){        $code=input('code');        //头像昵称        $infodata['nickname']=input('nickname');        $infodata['head_pic']=input('head_pic');        $weixin = new \app\api\controller\Weixin();        $openid=$weixin->get_openid($code);        if($openid){            $userinfo = M('users')->where((['openid'=>$openid]))->find();            $token = $userinfo['token'];            $token_expres = Token::checkTokenExpress($token);            if($userinfo){                //更新头像和昵称                M('users')->where(['openid'=>$openid])->save($infodata);                if($token_expres === true){                    $token_express = $userinfo['token_express'];                }else{                    $express = Token::updateTokenExpress($token);                    $token = $express['token'];                    $token_express = $express['express'];                }              echo  returnApiSuccess(['msg'=>'获取openid数据成功','token'=>$token,'user_id'=>$userinfo['user_id']]);            }else{                $user_id = Users::addUser($openid);                M('users')->where(['user_id'=>$user_id])->save($infodata);                $info = Users::get($user_id);               echo returnApiSuccess(['msg'=>'保存openid数据成功','token'=>$info['token'],'user_id'=>$info['user_id']]);            }        }else{           echo json_encode(array('msg'=>'获取openID失败','code'=>1000));        }    }}